<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Treemap to GeoJSON Tool</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.core.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            background-color: #F5F5F5;
            color: #333;
            margin: 0;
            padding: 2rem;
        }

        h2 {
            color: #0055A4;
        }

        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        input[type="file"],
        button {
            margin-top: 1rem;
            padding: 0.6rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: 4px;
        }

        input[type="file"] {
            background-color: #eee;
        }

        button {
            background-color: #0072CE;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0055A4;
        }

        svg {
            margin-top: 2rem;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>DW Treemap to GeoJSON Tool</h2>
        <p>Upload a CSV or Excel file with <strong>group</strong> and <strong>size</strong> columns to generate a
            treemap and export it as GeoJSON.</p>
        <input type="file" id="fileInput" accept=".csv, .xlsx" />
        <label for="tilingMethod">Tiling method:</label>
        <select id="tilingMethod">
            <option value="squarify">Squarify</option>
            <option value="binary">Binary</option>
            <option value="dice">Dice</option>
            <option value="slice">Slice</option>
            <option value="sliceDice">SliceDice</option>
        </select>
        <div id="chart"></div>
        <button onclick="downloadGeoJSON()">Download GeoJSON</button>
    </div>

    <script>
        let geojsonData = null;

        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById("tilingMethod").addEventListener("change", () => {
            if (geojsonData) {
                handleFile({ target: { files: [document.getElementById("fileInput").files[0]] } });
            }
        });


        function handleFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet);
                createTreemap(json);
            };

            reader.readAsArrayBuffer(file);
        }

        function createTreemap(data) {
            const width = 600, height = 400;
            d3.select("#chart").html("");

            const root = d3.hierarchy({ children: data })
                .sum(d => +d.size)
                .sort((a, b) => b.value - a.value);

            const method = document.getElementById("tilingMethod").value;
            const tilingMap = {
                squarify: d3.treemapSquarify,
                binary: d3.treemapBinary,
                dice: d3.treemapDice,
                slice: d3.treemapSlice,
                sliceDice: d3.treemapSliceDice
            };

            d3.treemap()
                .size([width, height])
                .padding(1)
                .tile(tilingMap[method])(root);


            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            svg.selectAll("rect")
                .data(root.leaves())
                .enter().append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", "#0072CE")
                .append("title")
                .text(d => `${d.data.group}: ${d.data.size}`);

            // Add two-line labels: group (bold) and size
            const labelGroup = svg.selectAll("text.group")
                .data(root.leaves())
                .enter()
                .append("text")
                .attr("class", "group")
                .attr("x", d => d.x0 + 4)
                .attr("y", d => d.y0 + 16)
                .attr("font-size", "12px")
                .attr("font-weight", "bold")
                .attr("fill", "white")
                .style("pointer-events", "none")
                .text(d => d.data.group);

            const labelSize = svg.selectAll("text.size")
                .data(root.leaves())
                .enter()
                .append("text")
                .attr("class", "size")
                .attr("x", d => d.x0 + 4)
                .attr("y", d => d.y0 + 32)
                .attr("font-size", "11px")
                .attr("fill", "white")
                .style("pointer-events", "none")
                .text(d => d.data.size);



            // Scale to 10x10 degree box
            const lonMin = -5, lonMax = 5;
            const latMin = -5, latMax = 5;

            const xExtent = d3.extent(root.leaves().flatMap(d => [d.x0, d.x1]));
            const yExtent = d3.extent(root.leaves().flatMap(d => [d.y0, d.y1]));

            function scaleX(x) {
                return lonMin + ((x - xExtent[0]) / (xExtent[1] - xExtent[0])) * (lonMax - lonMin);
            }

            function scaleY(y) {
                return latMax - ((y - yExtent[0]) / (yExtent[1] - yExtent[0])) * (latMax - latMin);
            }

            geojsonData = {
                type: "FeatureCollection",
                features: root.leaves().map(d => ({
                    type: "Feature",
                    properties: {
                        group: d.data.group,
                        size: d.data.size
                    },
                    geometry: {
                        type: "Polygon",
                        coordinates: [[
                            [scaleX(d.x0), scaleY(d.y0)],
                            [scaleX(d.x1), scaleY(d.y0)],
                            [scaleX(d.x1), scaleY(d.y1)],
                            [scaleX(d.x0), scaleY(d.y1)],
                            [scaleX(d.x0), scaleY(d.y0)]
                        ]]
                    }
                }))
            };
        }

        function downloadGeoJSON() {
            if (!geojsonData) {
                alert("Please upload data and generate the treemap first.");
                return;
            }
            const blob = new Blob([JSON.stringify(geojsonData, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "treemap.geojson";
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>